name: Deploy App to EC2 (Production)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_USERNAME: jefee
  DOCKER_FRONTEND_REPO: jefee/yanotela-frontend
  DOCKER_BACKEND_REPO: jefee/yanotela-backend
  EC2_USER: ubuntu
  DEPLOY_PATH: /var/www/yanotela

permissions:
  contents: write

jobs:
  cleanup:
    uses: ./.github/workflows/cleanup-console-logs.yml
    permissions:
      contents: write

  unit-tests:
    uses: ./.github/workflows/unit-tests.yml
    needs: cleanup
    permissions:
      contents: read

  setup:
    name: Setup Node.js and Checkout
    runs-on: ubuntu-latest
    needs: [cleanup, unit-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            Server/package-lock.json
            Client/package-lock.json

  install-dependencies:
    name: Install Dependencies (Server & Client)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - name: Install Server Dependencies
        run: |
          cd Server
          npm ci --prefer-offline --no-audit --progress=false
      - name: Install Client Dependencies
        run: |
          cd Client
          npm ci --prefer-offline --no-audit --progress=false

  build-frontend:
    name: Build and Push Frontend
    runs-on: ubuntu-latest
    needs: setup
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./Client
          file: ./Client/Dockerfile
          platforms: linux/amd64
          push: true
          build-args: |
            NEXT_PUBLIC_API_URL=https://yanotela.fr/api
            NEXT_PUBLIC_TURNSTILE_SITE_KEY=${{ secrets.PROD_TURNSTILE_SITE_KEY }}
          tags: |
            ${{ env.DOCKER_FRONTEND_REPO }}:latest
            ${{ env.DOCKER_FRONTEND_REPO }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-backend:
    name: Build and Push Backend
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./Server
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_BACKEND_REPO }}:latest
            ${{ env.DOCKER_BACKEND_REPO }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to Production EC2
    runs-on: ubuntu-latest
    needs: [install-dependencies, build-frontend, build-backend]
    environment: production
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 15.236.158.61
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "üöÄ Starting deployment to PRODUCTION environment"
            cd ${{ env.DEPLOY_PATH }}

            # Nettoyage cibl√©
            echo "üßπ Cleaning up disk space..."
            docker system prune -a -f --volumes || true
            docker container prune -f || true
            docker image prune -a -f || true
            docker volume prune -f || true
            docker network prune -f || true
            sudo apt-get clean || true
            sudo apt-get autoremove -y || true
            sudo journalctl --vacuum-time=3d || true
            sudo rm -rf /tmp/* || true
            sudo rm -rf /var/tmp/* || true
            sudo apt-get autoremove --purge -y || true

            # Mise √† jour du d√©p√¥t
            if [ ! -d ".git" ]; then
              git clone -b main https://github.com/FlorianMMI/Yanotela.git .
            else
              git fetch origin
              git reset --hard origin/main
            fi

            # Cr√©ation des fichiers de configuration
            mkdir -p ./nginx/conf.d
            cat > ./nginx/conf.d/default.conf << 'EOF'
            server {
                listen 80;
                client_max_body_size 100M;

                # Cloudflare Turnstile: g√©rer les requ√™tes /cdn-cgi/
                location ^~ /cdn-cgi/ {
                    return 204;
                }

                # Let's Encrypt (si besoin de renouvellement manuel)
                location ^~ /.well-known/acme-challenge/ {
                    root /var/www/yanotela;
                    try_files $uri =404;
                }

                location / {
                    proxy_pass http://frontend:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto https;
                    proxy_cache_bypass $http_upgrade;
                }

                location /api/ {
                    rewrite ^/api/(.*) /$1 break;
                    proxy_pass http://backend:3001;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto https;
                    proxy_cache_bypass $http_upgrade;
                    proxy_read_timeout 300s;
                    proxy_connect_timeout 75s;
                }

                location /yjs/ {
                    proxy_pass http://yjs-server:1234/;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto https;
                    proxy_read_timeout 86400;
                }

                location /health {
                    proxy_pass http://backend:3001/health;
                    proxy_set_header Host $host;
                }
            }
            EOF

            # docker-compose.yml
            cat > docker-compose.yml << 'EOF'
            version: '3.8'
            services:
              db:
                image: postgres:15-alpine
                container_name: yanotela-db
                environment:
                  POSTGRES_USER: yanotela
                  POSTGRES_PASSWORD: yanotela_prod_db_2024
                  POSTGRES_DB: yanotela
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                networks:
                  - yanotela
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U yanotela -d yanotela"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                restart: unless-stopped

              redis:
                image: redis:7-alpine
                container_name: yanotela-redis
                command: redis-server --requirepass yanotela_prod_redis_2024
                volumes:
                  - redis_data:/data
                networks:
                  - yanotela
                healthcheck:
                  test: ["CMD", "redis-cli", "-a", "yanotela_prod_redis_2024", "--raw", "incr", "ping"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                restart: unless-stopped

              backend:
                image: jefee/yanotela-backend:latest
                container_name: yanotela-backend
                env_file:
                  - .env.prod
                depends_on:
                  db:
                    condition: service_healthy
                  redis:
                    condition: service_healthy
                networks:
                  - yanotela
                restart: unless-stopped
                command: sh -c "npx prisma migrate deploy && npm start"

              yjs-server:
                image: node:18-alpine
                container_name: yanotela-yjs-server
                working_dir: /app
                environment:
                  - HOST=0.0.0.0
                  - PORT=1234
                  - YPERSISTENCE=/app/yjs-db
                volumes:
                  - ./Server/yjs-db:/app/yjs-db
                networks:
                  - yanotela
                command: sh -c "npm install -g @y/websocket-server && npx y-websocket"
                restart: unless-stopped
                healthcheck:
                  test: ["CMD", "nc", "-z", "localhost", "1234"]
                  interval: 10s
                  timeout: 3s
                  retries: 3

              frontend:
                image: jefee/yanotela-frontend:latest
                container_name: yanotela-frontend
                environment:
                  - NODE_ENV=production
                env_file:
                  - .env.prod
                depends_on:
                  - backend
                networks:
                  - yanotela
                restart: unless-stopped

              nginx:
                image: nginx:latest
                container_name: yanotela-nginx
                ports:
                  - "80:80"
                volumes:
                  - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
                depends_on:
                  - frontend
                  - backend
                networks:
                  - yanotela
                restart: unless-stopped
                logging:
                  driver: "json-file"
                  options:
                    max-size: "10m"
                    max-file: "3"

            volumes:
              postgres_data:
                driver: local
              redis_data:
                driver: local

            networks:
              yanotela:
                driver: bridge
            EOF

            # .env.prod - Variables d'environnement pour les containers
            cat > .env.prod << 'EOF'
            ${{ secrets.ENV_PROD }}
            EOF
            
            # Ajouter les variables Turnstile
            echo "TURNSTILE_SITE_KEY=${{ secrets.PROD_TURNSTILE_SITE_KEY }}" >> .env.prod
            echo "TURNSTILE_SECRET_KEY=${{ secrets.PROD_TURNSTILE_SECRET_KEY }}" >> .env.prod

            # D√©marrage des services
            docker compose down || true
            docker compose pull
            docker compose up -d --force-recreate

            # V√©rification active des services
            echo "‚è≥ Attente du d√©marrage des services..."
            timeout 60 bash -c 'until docker compose logs frontend | grep -q "ready"; do sleep 2; done'
            if docker compose ps | grep -q "Up"; then
              echo "‚úÖ Services d√©marr√©s avec succ√®s"
              echo "üéâ D√©ploiement PRODUCTION termin√© !"
            else
              echo "‚ùå √âchec du d√©marrage des services"
              docker compose logs
              exit 1
            fi
